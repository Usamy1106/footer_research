<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4x4 Grid Image Analyzer</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 40px; text-align: center; margin-bottom: 30px; background: #f8f9ff; }
        input[type="file"] { margin: 20px 0; padding: 10px; border: 2px solid #ddd; border-radius: 8px; }
        .preview-container { display: flex; gap: 30px; margin-bottom: 30px; }
        .image-preview, .grid-preview { flex: 1; }
        .image-preview img { max-width: 100%; height: auto; border-radius: 10px; }
        .grid-visualization {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            border: 2px solid #333;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .grid-cell {
            aspect-ratio: 1;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            text-align: center;
            background: white;
            border-radius: 5px;
            padding: 3px;
            white-space: pre-line;
        }
        .grid-cell.detected { background: #e3f2fd; border-color: #1976d2; font-weight: bold; }
        .grid-cell.logo-span { background: #fff3e0; border-color: #ff9800; }
        .grid-cell.span-continuation { background: #e8f5e8; border-color: #4caf50; opacity: 0.7; }
        .code-output {
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:disabled { background: #aaa; cursor: not-allowed; }
        #cameraContainer { margin-top: 20px; text-align: center; }
        #cameraVideo { border: 3px solid #667eea; border-radius: 10px; }
        .status { text-align: center; padding: 15px; border-radius: 10px; margin: 20px 0; font-weight: bold; }
        .status.success { background: #e8f5e8; color: #2e7d32; }
        .status.error { background: #fce8e6; color: #c62828; }
        .status.info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>4x4 Grid Image Analyzer</h1>
        <div class="upload-area">
            <h3>画像をアップロード</h3>
            <input type="file" id="imageInput" accept="image/*,.heic,.heif">
            <button id="cameraButton">カメラ起動</button>
            <div id="cameraContainer" style="display: none;">
                <video id="cameraVideo" width="400" height="400" autoplay></video>
                <canvas id="cameraCanvas" width="400" height="400" style="display: none;"></canvas>
                <button id="captureButton">撮影</button>
                <button id="stopCameraButton">停止</button>
            </div>
        </div>
        <div id="status" class="status" style="display: none;"></div>
        <div class="preview-container" id="previewContainer" style="display: none;">
            <div class="image-preview">
                <h3>アップロード画像</h3>
                <img id="uploadedImage">
            </div>
            <div class="grid-preview">
                <h3>検出結果</h3>
                <div class="grid-visualization" id="gridVisualization"></div>
            </div>
        </div>
        <div id="codeContainer" style="display: none;">
            <h3>生成コード</h3>
            <div class="code-output" id="codeOutput"></div>
        </div>
    </div>

    <script>
        const STRICT_PATTERNS = {
            'logo': { 
                patterns: ['logo', 'ロゴ', 'loco', 'loao', 'l0g0'], 
                name: 'ロゴ', 
                colspan: 2,
                needsGraphic: true
            },
            'sns': { 
                patterns: ['facebook', 'twitter', 'instagram', 'f', 'x', 'ig', 'sns'],
                name: 'SNS',
                needsGraphic: true
            },
            'home': { 
                patterns: ['home', 'ホーム', 'h0me'],
                name: 'Home'
            },
            'terms': { 
                patterns: ['利用規約', '規約', '利用', 'terms'],
                name: '利用規約'
            },
            'sitemap': { 
                patterns: ['サイトマップ', 'sitemap', 'site'],
                name: 'サイトマップ'
            },
            'privacy': { 
                patterns: ['プライバシーポリシー', 'プライバシー', 'privacy'],
                name: 'プライバシーポリシー'
            },
            'content': { 
                patterns: ['コンテンツ', 'お知らせ', 'プロダクト', 'content'],
                name: 'コンテンツ', 
                subItems: ['サイトマップ', 'お知らせ', 'プロダクト']
            },
            'support': { 
                patterns: ['サポート', 'お問い合わせ', 'よくある質問', 'faq', '資料請求', 'support'],
                name: 'サポート', 
                subItems: ['お問い合わせ', 'よくある質問(FAQ)', '資料請求']
            },
            'policy': { 
                patterns: ['ポリシー', 'cookie', 'クッキー', 'policy'],
                name: 'ポリシー', 
                subItems: ['プライバシーポリシー', '利用規約', 'cookieポリシー']
            },
            'phone': { 
                patterns: ['tel', '042', '637', '8111', '0426378111'],
                name: 'TEL. 042-637-8111'
            },
            'copyright': { 
                patterns: ['©', '2025', 'logo', 'copyright', 'copy'],
                name: '© 2025 Logo'
            }
        };

        let cameraStream = null, currentImage = null, ocrWorker = null;
        const els = {
            imageInput: document.getElementById('imageInput'),
            uploadedImage: document.getElementById('uploadedImage'),
            previewContainer: document.getElementById('previewContainer'),
            gridVisualization: document.getElementById('gridVisualization'),
            codeContainer: document.getElementById('codeContainer'),
            codeOutput: document.getElementById('codeOutput'),
            status: document.getElementById('status'),
            cameraButton: document.getElementById('cameraButton'),
            cameraContainer: document.getElementById('cameraContainer'),
            cameraVideo: document.getElementById('cameraVideo'),
            captureButton: document.getElementById('captureButton'),
            stopCameraButton: document.getElementById('stopCameraButton'),
            cameraCanvas: document.getElementById('cameraCanvas')
        };

        function status(msg, type = 'info') {
            els.status.textContent = msg;
            els.status.className = `status ${type}`;
            els.status.style.display = 'block';
            console.log(`[${type}] ${msg}`);
        }

        function initGrid() {
            els.gridVisualization.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.textContent = `${i + 1}`;
                els.gridVisualization.appendChild(cell);
            }
        }

        async function initOCR() {
            status('OCR初期化中...');
            try {
                ocrWorker = await Tesseract.createWorker('jpn+eng');
                status('OCR準備完了', 'success');
            } catch (e) {
                status('OCR初期化失敗', 'error');
            }
        }

        async function handleFile(file) {
            if (!file.type.startsWith('image/') && !file.name.match(/\.(heic|heif)$/i)) {
                status('対応していないファイル形式', 'error');
                return;
            }

            let proc = file;
            if (file.name.match(/\.(heic|heif)$/i)) {
                try {
                    status('HEIC変換中...');
                    const blobs = await heic2any({ blob: file, toType: 'image/jpeg', quality: 0.9 });
                    proc = Array.isArray(blobs) ? blobs[0] : blobs;
                } catch (e) {
                    status('HEIC変換失敗', 'error');
                    return;
                }
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                els.uploadedImage.src = currentImage;
                els.previewContainer.style.display = 'block';
                initGrid();
                status('解析開始...', 'info');
                setTimeout(() => analyze(), 500);
            };
            reader.readAsDataURL(proc);
        }

        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 400, height: 400, aspectRatio: 1.0, facingMode: 'environment' }
                });
                els.cameraVideo.srcObject = cameraStream;
                els.cameraContainer.style.display = 'block';
                els.cameraButton.style.display = 'none';
            } catch (e) {
                status('カメラ起動失敗', 'error');
            }
        }

        function capturePhoto() {
            const ctx = els.cameraCanvas.getContext('2d');
            ctx.drawImage(els.cameraVideo, 0, 0, 400, 400);
            els.cameraCanvas.toBlob((blob) => {
                handleFile(new File([blob], 'capture.jpg', { type: 'image/jpeg' }));
                stopCamera();
            }, 'image/jpeg');
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
            }
            els.cameraContainer.style.display = 'none';
            els.cameraButton.style.display = 'inline-block';
        }

        async function analyze() {
            if (!ocrWorker) {
                status('OCRが利用できません', 'error');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = async () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                const cw = canvas.width / 4;
                const ch = canvas.height / 4;
                const detected = {};

                for (let i = 0; i < 16; i++) {
                    const row = Math.floor(i / 4);
                    const col = i % 4;
                    status(`セル ${i + 1}/16 解析中...`);

                    const cc = document.createElement('canvas');
                    cc.width = cw;
                    cc.height = ch;
                    const cctx = cc.getContext('2d');
                    cctx.drawImage(canvas, col * cw, row * ch, cw, ch, 0, 0, cw, ch);

                    const hasGraphic = checkGraphic(cctx);

                    try {
                        const { data: { text } } = await ocrWorker.recognize(cc);
                        const clean = text.toLowerCase().replace(/[^\w\sぁ-んァ-ヶ一-龯]/g, '');
                        
                        const type = matchStrictPattern(clean, hasGraphic, row);
                        if (type) {
                            detected[i] = { type, element: STRICT_PATTERNS[type] };
                        }
                    } catch (e) {
                        if (hasGraphic && row < 2) {
                            detected[i] = { type: 'logo', element: STRICT_PATTERNS['logo'] };
                        }
                    }
                }

                processLogo(detected);
                display(detected);
                generateCode(detected);
                status('解析完了', 'success');
            };

            img.src = currentImage;
        }

        function checkGraphic(ctx) {
            const data = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height).data;
            let dark = 0;
            for (let i = 0; i < data.length; i += 4) {
                if ((data[i] + data[i+1] + data[i+2]) / 3 < 200) dark++;
            }
            return dark / (data.length / 4) > 0.1;
        }

        function matchStrictPattern(text, hasGraphic, row) {
            const lower = text.toLowerCase();
            
            // ロゴの特別処理：上段でグラフィック要素がある場合
            if (hasGraphic && row < 2) {
                // "logo"というテキストが含まれているか確認
                if (lower.includes('logo') || lower.includes('ロゴ') || lower.includes('loco') || lower.includes('l0g0')) {
                    return 'logo';
                }
            }
            
            // 他のパターンマッチング（優先順位順）
            // 複数項目グループを優先的にチェック
            if (lower.includes('コンテンツ') || (lower.includes('お知らせ') && lower.includes('プロダクト'))) {
                return 'content';
            }
            if (lower.includes('サポート') || (lower.includes('お問い合わせ') && lower.includes('よくある質問'))) {
                return 'support';
            }
            if ((lower.includes('ポリシー') && !lower.includes('プライバシー')) || lower.includes('cookie')) {
                return 'policy';
            }
            
            // 電話番号
            if (lower.includes('tel') || lower.match(/042.*637.*8111/) || lower.includes('0426378111')) {
                return 'phone';
            }
            
            // コピーライト
            if ((lower.includes('©') || lower.includes('copyright') || lower.includes('copy')) && lower.includes('2025')) {
                return 'copyright';
            }
            
            // SNS（グラフィック要素があり、かつSNS関連の文字がある場合）
            if (hasGraphic && (lower.includes('facebook') || lower.includes('twitter') || lower.includes('instagram') || lower.match(/^[fx]$/))) {
                return 'sns';
            }
            
            // 個別要素
            if (lower.includes('home') || lower.includes('ホーム')) return 'home';
            if (lower.includes('利用規約') || (lower.includes('利用') && lower.includes('規約'))) return 'terms';
            if (lower.includes('サイトマップ') && !lower.includes('コンテンツ')) return 'sitemap';
            if (lower.includes('プライバシーポリシー') || lower.includes('プライバシー')) return 'privacy';
            
            return null;
        }

        function processLogo(detected) {
            const logos = Object.keys(detected).filter(i => detected[i].type === 'logo').map(Number);
            if (logos.length > 0) {
                const main = logos[0];
                const col = main % 4;
                if (col < 3) {
                    detected[main].colspan = 2;
                    detected[main + 1] = { type: 'logo-span', isSpan: true };
                    logos.slice(1).forEach(i => { if (i !== main + 1) delete detected[i]; });
                }
            }
        }

        function display(detected) {
            const cells = els.gridVisualization.querySelectorAll('.grid-cell');
            cells.forEach((cell, i) => {
                const data = detected[i];
                cell.className = 'grid-cell';
                if (data) {
                    cell.classList.add('detected');
                    if (data.isSpan) {
                        cell.classList.add('span-continuation');
                        cell.textContent = '← ロゴ続き';
                    } else {
                        if (data.type === 'logo') cell.classList.add('logo-span');
                        let txt = data.element.name;
                        if (data.element.subItems) txt += '\n' + data.element.subItems.join('\n');
                        if (data.colspan) txt += ' (2列)';
                        cell.textContent = txt;
                    }
                } else {
                    cell.textContent = `${i + 1}`;
                }
            });
        }

        function generateCode(detected) {
            let html = '', css = `.grid-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: 20px;
    padding: 20px;
    min-height: 100vh;
}

`;
            const proc = new Set();

            Object.entries(detected).forEach(([i, data]) => {
                const idx = parseInt(i);
                if (data.isSpan || proc.has(idx)) return;

                const row = Math.floor(idx / 4) + 1;
                const col = (idx % 4) + 1;
                const cls = `grid-item-${idx + 1}`;
                const span = data.colspan || 1;

                let content = '';
                if (data.type === 'logo') content = `<img src="logo.png" alt="Logo">`;
                else if (data.type === 'sns') content = `<div class="sns">SNS Icons</div>`;
                else if (data.type === 'phone') content = `<a href="tel:042-637-8111">${data.element.name}</a>`;
                else if (data.type === 'copyright') content = `<small>${data.element.name}</small>`;
                else if (data.element.subItems) {
                    content = `<div><h4>${data.element.name}</h4><ul>${data.element.subItems.map(s => `<li>${s}</li>`).join('')}</ul></div>`;
                } else {
                    content = `<a href="#">${data.element.name}</a>`;
                }

                html += `    <div class="${cls}">${content}</div>\n`;
                css += `.${cls} {
    grid-column: ${col}${span > 1 ? ` / span ${span}` : ''};
    grid-row: ${row};
    display: flex;
    align-items: center;
    justify-content: center;
}

`;
                proc.add(idx);
                if (span > 1) proc.add(idx + 1);
            });

            els.codeOutput.textContent = `<!DOCTYPE html>
<html>
<head><style>
${css}</style></head>
<body>
    <div class="grid-container">
${html}    </div>
</body>
</html>`;
            els.codeContainer.style.display = 'block';
        }

        els.imageInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        els.cameraButton.addEventListener('click', startCamera);
        els.captureButton.addEventListener('click', capturePhoto);
        els.stopCameraButton.addEventListener('click', stopCamera);

        initGrid();
        initOCR();
    </script>
</body>
</html>